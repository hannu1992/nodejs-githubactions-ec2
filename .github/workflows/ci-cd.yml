name: CI & CD to EC2 (Docker Hub)

on:
  push:
    branches: [ main ]

env:
  IMAGE_NAME: ${{ secrets.DOCKERHUB_USERNAME }}/nodejs-githubactions-ec2-deploy

jobs:
  build-and-push:
    name: Build and Push Docker image
    runs-on: ubuntu-latest
    outputs:
      image-tag: ${{ steps.set-tag.outputs.IMAGE_TAG }}
    steps:
      - name: checkout
        uses: actions/checkout@v4

      - name: Set image tag
        id: set-tag
        run: echo "IMAGE_TAG=main-${{ github.sha }}" >> $GITHUB_OUTPUT

      - name: Log in to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push
        uses: docker/build-push-action@v4
        with:
          context: .
          push: true
          tags: |
            ${{ env.IMAGE_NAME }}:${{ steps.set-tag.outputs.IMAGE_TAG }}
            ${{ env.IMAGE_NAME }}:latest
          build-args: |
            APP_VERSION=${{ github.sha }}

      - name: Set output tag
        run: echo "IMAGE_TAG=main-${{ github.sha }}" >> $GITHUB_OUTPUT

  deploy-to-ec2:
    name: Deploy to EC2 via SSH
    runs-on: ubuntu-latest
    needs: build-and-push
    steps:
      - name: Wait for image tag
        run: echo "Using image tag from prior step"

      - name: Deploy - SSH and restart container
        uses: appleboy/ssh-action@v0.1.9
        with:
          host: ${{ secrets.EC2_HOST }}            # EC2 public IP or DNS
          username: ${{ secrets.EC2_USER }}        # usually 'ec2-user', 'ubuntu', or custom
          key: ${{ secrets.EC2_SSH_KEY }}          # private key (PEM) stored as secret
          port: 22
          timeout: 600
          script: |
            set -e
            IMAGE="${{ env.IMAGE_NAME }}:main-${{ github.sha }}"
            echo "Pulling image: $IMAGE"
            docker pull $IMAGE || { echo "pull failed"; exit 1; }

            # stop & remove old container if exists
            if docker ps -a --format '{{.Names}}' | grep -w my-node-app; then
              echo "Stopping existing container..."
              docker stop my-node-app || true
              docker rm my-node-app || true
            fi

            # run new container (listen on host 80 -> container 3000)
            docker run -d \
              --name my-node-app \
              --restart unless-stopped \
              -p 80:3000 \
              -e APP_VERSION="${{ github.sha }}" \
              $IMAGE

            echo "Deployment finished. Container running:"
            docker ps --filter name=my-node-app --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
