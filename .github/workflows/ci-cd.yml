name: CI & CD to EC2 (Docker Hub) - testing only

on:
  push:
    branches:
      - testing
  workflow_dispatch: {}

env:
  IMAGE_NAME: ${{ secrets.DOCKERHUB_USERNAME }}/nodejs-githubactions-ec2

jobs:
  build-and-push:
    name: Build and Push Docker image
    runs-on: ubuntu-latest
    outputs:
      image-tag: ${{ steps.set-tag.outputs.IMAGE_TAG }}
    steps:
      - name: checkout
        uses: actions/checkout@v4

      - name: Set image tag
        id: set-tag
        run: echo "IMAGE_TAG=testing-${{ github.sha }}" >> $GITHUB_OUTPUT

      - name: Log in to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push
        uses: docker/build-push-action@v4
        with:
          context: .
          push: true
          tags: |
            ${{ env.IMAGE_NAME }}:${{ steps.set-tag.outputs.IMAGE_TAG }}
            ${{ env.IMAGE_NAME }}:latest
          build-args: |
            APP_VERSION=${{ github.sha }}

  deploy-testing:
    name: Deploy to Testing EC2
    runs-on: ubuntu-latest
    needs: build-and-push
    environment: testing
    steps:
      - name: Deploy - SSH and restart container (testing)
        uses: appleboy/ssh-action@v0.1.9
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          timeout: 10m
          script: |
            set -e
            IMAGE="${{ env.IMAGE_NAME }}:${{ needs.build-and-push.outputs.image-tag }}"
            echo "Pulling image: $IMAGE"
            docker pull $IMAGE || { echo "pull failed"; exit 1; }

            if docker ps -a --format '{{.Names}}' | grep -w my-node-app; then
              echo "Stopping existing container..."
              docker stop my-node-app || true
              docker rm my-node-app || true
            fi

            docker run -d \
              --name my-node-app \
              --restart unless-stopped \
              -p 80:3000 \
              -e APP_VERSION="${{ needs.build-and-push.outputs.image-tag }}" \
              $IMAGE

            echo "Deployment finished. Container running:"
            docker ps --filter name=my-node-app --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
